{% extends 'app/base.html' %}

{% block content %}

<div class="page-body" style="margin: auto; padding: 20px 20px 20px 30px;">
    <a href="{% url 'customer_brycen_file_select' %}" type="button" class="btn btn-outline-primary">入力フォーム</a><br><br>
    <a href="{% url 'file_upload' %}" type="button" class="btn btn-outline-primary">新規案件を進める</a><br><br>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">途中案件</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="content-tab" data-toggle="tab" href="#content" role="tab" aria-controls="content" aria-selected="false">終了案件</a>
      </li>
    </ul>
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab" width="600rem">
            <table class="table table-sm table-hover" id="incompleteTable"
                   cellspacing="0" cellpadding="5"
                   data-filter-control="true" data-show-search-clear-button="true">

                <thead class="thead-light">
                    <tr>
                        <th>NO.</th>
                        <th>最終更新日</th>
                        <th>ステータス</th>
                        <th>取引先</th>
                        <th>担当者</th>
                        <th>請求データ/目視確認ファイル</th>
                        <th></th>
                    </tr>
                </thead><br>
                <tbody>
                {% for m in matched %}
                {% if m.generated.status is 0 or m.generated.status is 1%}
                 <tr>
                        <td>{{ m.generated.pk }}</td>
                        {% if m.matched_data_file %}
                        <td><a href="{%url 'detail_and_create' pk=m.pk %}">{{ m.created_date|date:"Y/n/j H:i" }}</a></td>
                        {% else %}
                        <td><a href="{%url 'select_billing_file_or_form' pk=m.pk %}">{{ m.created_date|date:"Y/n/j H:i" }}</a></td>
                        {% endif %}
                        {% if m.generated.status == 0 %}
                        <td>{{ m.generated.status }}:請求データ未作成</td>
                        {% elif m.generated.status == 1 %}
                        <td>{{ m.generated.status }}:CSV出力済</td>
                        {% endif %}
                        <td>{{ m.generated.customer }}</td>
                        <td>{{ m.staff}}</td>
                        <td>請求データ</td>
                        {% if m.billing_file and m.matched_data_file %}
                        <td>
                            <a href="{{ m.billing_file.url }}">{{ m.billing_filename }}</a>
                        </td>
                        {% elif not m.billing_file and m.matched_data_file %}
                        <td>
                            <span class="badge badge-pill badge-info">入力データあり</span>
                            <a href="{%url 'detail_and_create' pk=m.pk %}">案件詳細画面へ</a>
                        </td>
                        {% else %}
                        <td>
                            ファイルをアップロードもしくは、データを入力してください。
                        </td>
                        {% endif %}
                    </tr>
                {% endif %}
                {% endfor %}

                {% for v in visually_matched %}
                {% if v.matched.generated.status is 2 %}
                    <tr>
                        <td>{{ v.id }}:{{ v.matched.generated.pk }}</td>
                        <td><a href="{%url 'import_data' pk=v.pk %}">{{ v.created_date|date:"Y/n/j H:i" }}</a></td>
                        <td>(status:{{ v.matched.generated.status }})目視確認済</td>
                        <td>{{ v.matched.generated.customer }}</td>
                        <td>{{ v.staff}}</td>
                        <td>目視確認ファイル</td>
                        <td><a href="{{ v.matched.matched_data_file.url }}" download="{{ name }}">{{ v.matched.matched_data_filename }}</a></td>
                    </tr>
                {% endif %}
                {% endfor %}
                </tbody>
            </table>
      </div>
    <div class="tab-pane fade" id="content" role="tabpanel" aria-labelledby="content-tab">
            <table class="table table-sm table-hover" id="completedTable" data-filter-control="true"
                    cellspacing="0" cellpadding="5">
                <thead class="thead">
                    <tr>
                        <th>NO.</th>
                        <th data-field="export-date" data-filter-control="input">インポートデータ出力日</th>
                        <th data-field="staff" data-filter-control="select">担当者</th>
                        <th data-field="customer" data-filter-control="select">取引先</th>
                        <th data-field="billing-data" data-filter-control="input">請求データ</th>
                        <th data-field="csv-type" data-filter-control="select">CSV修正有無</th>
                    </tr>
                </thead><br>
                <tbody>
                {% for i in import_data %}
                {% if i.visually_matched.matched.generated.status is 3 %}
                    <tr>
                        <td>{{ i.visually_matched.matched.generated.pk }}</td>
                        <td><a href="{% url 'import_data_detail' pk=i.pk %}">{{ i.created_date|date:"Y/n/j H:i" }}</a></td>
                        <td>{{ i.staff }}</td>
                        <td>{{ i.visually_matched.matched.generated.customer }}</td>
                        {% if i.visually_matched.matched.billing_file %}
                        <td><a href="{{ i.visually_matched.matched.billing_file.url }}">{{ i.visually_matched.matched.billing_filename }}</a></td>
                        {% else %}
                        <td>None</td>
                        {% endif %}
                        {% if i.visually_matched_file %}
                        <td>あり</td>
                        {% else %}
                        <td>なし</td>
                        {% endif %}
                    {% endif %}
                    {% endfor %}
                    </tr>
                </tbody>
            </table>
    </div>
    </div>
</div>

<!--  -->
<!-- フィルタ対象のテーブル -->
<!-- <th>,<td>に「cmanFilterBtn」を定義するとフィルタボタンが付きます -->
<!--  -->

<script>
  $(function() {
    $('#completedTable').bootstrapTable()
  })
</script>
{% comment %}
<style type="text/css">
/* === フィルタボタン ============================ */
.tfArea{
  display    : inline-block;
  position   : relative;
}
.tfImg{
  display    : inline-block;
  width      : 20px;
  height     : 18px;
  background : #eee;
  border     : 1px solid #777;
  margin     : 1px 3px;
  padding    : 3px;
  cursor     : pointer;
}
/* === フィルタボタン（カーソルオーバー時）======= */
.tfImg:hover{
  background : #FFD700;
}
/* === フィルタボタン内の画像色（SVG）============ */
.tfImg path{
  fill       : #777;
}
/* === フィルタリスト ============================ */
.tfList{
  display    : inline-block;
  position   : absolute;
  max-width  : 250px;
  min-width  : 140px;
  background : #fff;
  border     : 1px solid #777;
  top        : 15px;
  left       : 0;
  line-height: 1.1;
  font-weight: normal;
}
/* === フィルタリスト内のform ==================== */
.tfList form{
  max-height : 150px;           /* 縦幅 */
  overflow   : scroll;
  overflow   : overflow-y;
  overflow   : auto;
}
/* === フィルタリスト内のチェックボックス ======== */
.tfMeisai{
  text-align : left;
  padding    : 2px;
}
/* === フィルタリスト内の文字位置合わせ ========== */
.tfMeisai label{
  padding    : 0 10px 0 3px;
}
/* === OK/CANCELボタン =========================== */
.tfBtnArea{
  text-align : center;
  font-size  : 8pt;
  padding    : 3px 5px;
}
.tfBtnArea input{
  display    : inline-block;
  margin     : 0 5px;
}
/* === 含むボタンの入力エリア ==================== */
.tfInStr{
  padding    : 5px 3px;
  border-top : 1px solid #999;
  border-bottom: 1px solid #999;
}
.tfInStr input{
  box-sizing : border-box;
  width      : 100%;
  padding    : 1px 3px;
  font-weight: normal;
  font-size  : 95%;
  border     : 1px solid #ccc;
}
/* === フィルタ非表示 ============================ */
#incompleteTable tr[cmanFilterNone]{
  display    : none;
}
/* === フィルタ非表示行と次行の間を二重線にする == */
#incompleteTable tr[cmanFilterNone] + tr td{
  border-top : 3px double #777;
}
 /* --- （参考）テーブル全体のスタイル指定 ------- */
#incompleteTable {
  width          : 100%;
<!--  border-collapse: collapse;         /* 境界線結合 */-->
<!--  border-spacing : 0;                /* 罫線間余白 */-->
<!--  font-size      : 10pt;              /* 文字サイズ */-->
}
 /* --- ヘッダーのスタイル指定 ------------------- */
<!--#incompleteTable th {-->
<!--  text-align    : left;            /* 文字位置   */-->
<!--  font-weight   : bold;              /* 太文字     */-->
<!--  padding       : 3px 5px;          /* 余白       */-->
<!--  border        : 1px #666666 solid; /* 罫線       */-->
<!--  background    : #dcdcdc;          /* 背景色     */-->
<!--  white-space   : nowrap;-->
}
 /* --- 明細のスタイル指定 ----------------------- */
<!--#incompleteTable td {-->
<!--  text-align    : left;            /* 文字位置   */-->
<!--  padding       : 3px 5px;           /* 余白       */-->
<!--  border        : 1px #666666 solid; /* 罫線       */-->
<!--  white-space   : nowrap;-->
}
</style>
<script type="text/javascript">
 //===============================================================
 //  フィルタテーブルの共通変数　設定要！
 //===============================================================
var gTabldID = 'incompleteTable';  // テーブルのエリアのIDを設定
var gTfStartRow = 0;
var gTfColList  = [];             // ボタンが配置されている列番号
var gTfListSave = {};             // フィルタリストの保存状態

 //===============================================================
 //  オンロードでテーブル初期設定関数をCALL
 //===============================================================
window.onload = function() {
  tFilterInit();

}

function tFilterInit(){
 //==============================================================
 //  テーブルの初期設定
 //==============================================================
  var wTABLE  = document.getElementById(gTabldID);
  var wTR     = wTABLE.rows;
  var wAddBtn = '';

  // ------------------------------------------------------------
  //   テーブル内をフィルタボタンを付ける
  // ------------------------------------------------------------
  for(var i=0; i < wTR.length; i++){

    var wTD     = wTABLE.rows[i].cells;

    for(var j=0; j < wTD.length; j++){

      // --- 「cmanFilterBtn」の定義があるセルを対象とする ------
      if(wTD[j].getAttribute('cmanFilterBtn') !== null){

        // --- フィルタ対象はボタンの次の行から -----------------
        gTfStartRow = i + 1;

        // --- ボタンを追加（画像はsvgを使用） ------------------
        wAddBtn  = '<div class="tfArea">';
        wAddBtn += '<svg class="tfImg" id="tsBtn_'+j+'" onclick="tFilterCloseOpen('+j+')"><path d="M0 0 L9 0 L6 4 L6 8 L3 8 L3 4Z"></path></svg>';
        wAddBtn += '<div class="tfList" id="tfList_'+j+'" style="display:none">';
        wAddBtn += tFilterCreate(j);
        wAddBtn += '</div>';
        wAddBtn += '</div>';
        wTD[j].innerHTML = wTD[j].innerHTML+wAddBtn;

        // --- フィルタボタンなる列を保存 -----------------------
        gTfColList.push(j);
      }
    }

    // --- ボタンを付けたら以降の行は無視する -------------------
    if(wAddBtn != ''){
      gSortBtnRow = i;
      break;
    }

  }
}

function tFilterCreate(argCol){
 //==============================================================
 //  指定列のフィルタリスト作成
 //==============================================================

  var wTABLE    = document.getElementById(gTabldID);
  var wTR       = wTABLE.rows;
  var wItem     = [];              // クリックされた列の値
  var wNotNum   = 0;               // 1 : 数字でない
  var wItemSave = {};              // フィルタに設定した値がキー
  var rcList    = '';              // 返すフィルタリスト

  // ------------------------------------------------------------
  //  クリックされた列の値を取得する
  // ------------------------------------------------------------
  for(var i=gTfStartRow; i < wTR.length; i++){
    var j = i - gTfStartRow;

    wItem[j] = wTR[i].cells[argCol].innerText.toString();

    if(wItem[j].match(/^[-]?[0-9,\.]+$/)){
    }else{
        wNotNum = 1;
    }

  }

  // ------------------------------------------------------------
  //  列の値でソートを実行
  // ------------------------------------------------------------
    if(wNotNum == 0){
      wItem.sort(sortNumA);           // 数値で昇順
    }else{
      wItem.sort(sortStrA);           // 文字で昇順
    }

  // ------------------------------------------------------------
  //  「すべて」のチェックボックス作成
  // ------------------------------------------------------------
  var wItemId =  id='tfData_ALL_'+argCol;

  rcList += '<div class="tfMeisai">';
  rcList += '<input type="checkbox" id="'+wItemId+'" checked onclick="tFilterAllSet('+argCol+')">';
  rcList += '<label for="'+wItemId+'">(すべて)</label>';
  rcList += '</div>';

  // ------------------------------------------------------------
  //  列の値でフィルタのチェックボックスを作成する
  //    チェックボックスはformで囲む
  // ------------------------------------------------------------
  rcList += '<form name="tfForm_'+argCol+'">';

  for(var i=0; i < wItem.length; i++){

    wVal = trim(wItem[i]);

    if(wVal in wItemSave){
      // ---値でチェックボックスが作成されている(重複) ----------
    }else{

      // ---チェックボックスの作成 ------------------------------
      wItemId =  id='tfData_'+argCol+'_r'+i;
      rcList += '<div class="tfMeisai">';
      rcList += '<input type="checkbox" id="'+wItemId+'" value="'+wVal+'" checked onclick="tFilterClick('+argCol+')">';
      rcList += '<label for="'+wItemId+'">'+( wVal=='' ? '(空白)' : wVal )+'</label>';
      rcList += '</div>';

      // ---重複判定用にチェックボックスの値を保存 --------------
      wItemSave[wVal]='1';
    }
  }
  rcList += '</form>';

  // ------------------------------------------------------------
  //  文字抽出のinputを作成
  // ------------------------------------------------------------
  rcList += '<div class="tfInStr">';
  rcList += '<input type="text" placeholder="含む文字抽出" id="tfInStr_'+argCol+'">';
  rcList += '</div>';

  // ------------------------------------------------------------
  //  「OK」「Cancel」ボタンの作成
  // ------------------------------------------------------------
  rcList += '<div class="tfBtnArea">';
  rcList += '<input type="button" value="OK" onclick="tFilterGo()">';
  rcList += '<input type="button" value="Cancel" onclick="tFilterCancel('+argCol+')">';
  rcList += '</div>';

  // ------------------------------------------------------------
  //  作成したhtmlを返す
  // ------------------------------------------------------------
  return rcList;

}

function tFilterClick(argCol){
 //==============================================================
 //  フィルタリストのチェックボックスクリック
 //    「すべて」のチェックボックスと整合性を合わせる
 //==============================================================
  var wForm   = document.forms['tfForm_'+argCol];
  var wCntOn  = 0;
  var wCntOff = 0;
  var wAll    = document.getElementById('tfData_ALL_'+argCol);   // 「すべて」のチェックボックス

  // --- 各チェックボックスの状態を集計する ---------------------
  for (var i = 0; i < wForm.elements.length; i++){
    if(wForm.elements[i].type == 'checkbox'){
      if (wForm.elements[i].checked) { wCntOn++;  }
      else                           { wCntOff++; }
    }
  }

  // --- 各チェックボックス集計で「すべて」を整備する -----------
  if((wCntOn == 0)||(wCntOff == 0)){
    wAll.checked = true;             // 「すべて」をチェックする
    tFilterAllSet(argCol);           // 各フィルタのチェックする
  }else{
     wAll.checked = false;           // 「すべて」をチェックを外す
  }
}

function tFilterCancel(argCol){
 //==============================================================
 //  キャンセルボタン押下
 //==============================================================

  tFilterSave(argCol, 'load');    // フィルタ条件の復元
  tFilterCloseOpen('');           // フィルタリストを閉じる

}

function tFilterGo(){
 //===============================================================
 //  フィルタの実行
 //===============================================================
  var wTABLE  = document.getElementById(gTabldID);
  var wTR     = wTABLE.rows;

  // ------------------------------------------------------------
  //  全ての非表示を一旦クリア
  // ------------------------------------------------------------
  for(var i = 0; i < wTR.length; i++){
    if(wTR[i].getAttribute('cmanFilterNone') !== null){
      wTR[i].removeAttribute('cmanFilterNone');

    }
  }

  // ------------------------------------------------------------
  //  フィルタボタンのある列を繰り返す
  // ------------------------------------------------------------
  for(var wColList = 0; wColList < gTfColList.length; wColList++){
    var wCol       = gTfColList[wColList];
    var wAll       = document.getElementById('tfData_ALL_'+wCol);     // 「すべて」のチェックボックス
    var wItemSave  = {};
    var wFilterBtn =  document.getElementById('tsBtn_'+wCol);
    var wFilterStr =  document.getElementById('tfInStr_'+wCol);

    var wForm      = document.forms['tfForm_'+wCol];
    // -----------------------------------------------------------
    //  チェックボックスの整備（「すべて」の整合性）
    // -----------------------------------------------------------
    for (var i = 0; i < wForm.elements.length; i++){
      if(wForm.elements[i].type == 'checkbox'){
        if (wForm.elements[i].checked) {
          wItemSave[wForm.elements[i].value] = 1;      // チェックされている値を保存
        }
      }
    }

    // -----------------------------------------------------------
    //  フィルタ（非表示）の設定
    // -----------------------------------------------------------
    if((wAll.checked)&&(trim(wFilterStr.value) == '')){
      wFilterBtn.style.backgroundColor = '';              // フィルタなし色
    }
    else{
      wFilterBtn.style.backgroundColor = '#ffff00';       // フィルタあり色

      for(var i=gTfStartRow; i < wTR.length; i++){

        var wVal = trim(wTR[i].cells[wCol].innerText.toString());

        // --- チェックボックス選択によるフィルタ ----------------
        if(!wAll.checked){
          if(wVal in wItemSave){
          }
          else{
            wTR[i].setAttribute('cmanFilterNone','');
          }
        }

        // --- 抽出文字によるフィルタ ----------------------------
        if(wFilterStr.value != ''){
          reg = new RegExp(wFilterStr.value);
          if(wVal.match(reg)){
          }
          else{
            wTR[i].setAttribute('cmanFilterNone','');
          }
        }
      }
    }
  }

  tFilterCloseOpen('');
}

function tFilterSave(argCol, argFunc){
 //==============================================================
 //  フィルタリストの保存または復元
 //==============================================================

  // ---「すべて」のチェックボックス値を保存 ------------------
  var wAllCheck = document.getElementById('tfData_ALL_'+argCol);
  if(argFunc == 'save'){
    gTfListSave[wAllCheck.id] = wAllCheck.checked;
  }else{
    wAllCheck.checked = gTfListSave[wAllCheck.id];
  }

  // --- 各チェックボックス値を保存 ---------------------------
  var wForm    = document.forms['tfForm_'+argCol];
  for (var i = 0; i < wForm.elements.length; i++){
    if(wForm.elements[i].type == 'checkbox'){
      if(argFunc == 'save'){
        gTfListSave[wForm.elements[i].id] = wForm.elements[i].checked;
      }else{
        wForm.elements[i].checked = gTfListSave[wForm.elements[i].id];
      }
    }
  }

  // --- 含む文字の入力を保存 ---------------------------------
  var wStrInput = document.getElementById('tfInStr_'+argCol);
  if(argFunc == 'save'){
    gTfListSave[wStrInput.id] = wStrInput.value;
  }else{
    wStrInput.value = gTfListSave[wStrInput.id];
  }
}

function tFilterCloseOpen(argCol){
 //==============================================================
 //  フィルタを閉じて開く
 //==============================================================

  // --- フィルタリストを一旦すべて閉じる -----------------------
  for(var i=0; i < gTfColList.length; i++){
    document.getElementById("tfList_"+gTfColList[i]).style.display = 'none';
  }

  // --- 指定された列のフィルタリストを開く ---------------------
  if(argCol != ''){
    document.getElementById("tfList_"+argCol).style.display = '';

    // --- フィルタ条件の保存（キャンセル時に復元するため） -----
    tFilterSave(argCol, 'save');

  }
}

function tFilterAllSet(argCol){
 //==============================================================
 //  「すべて」のチェック状態に合わせて、各チェックをON/OFF
 //==============================================================
  var wChecked = false;
  var wForm    = document.forms['tfForm_'+argCol];

  if(document.getElementById('tfData_ALL_'+argCol).checked){
    wChecked = true;
  }

  for (var i = 0; i < wForm.elements.length; i++){
    if(wForm.elements[i].type == 'checkbox'){
      wForm.elements[i].checked = wChecked;
    }
  }
}

function sortNumA(a, b) {
 //==============================================================
 //  数字のソート関数（昇順）
 //==============================================================
  a = parseInt(a.replace(/,/g, ''));
  b = parseInt(b.replace(/,/g, ''));

  return a - b;
}

function sortStrA(a, b){
 //==============================================================
 //  文字のソート関数（昇順）
 //==============================================================
  a = a.toString().toLowerCase();  // 英大文字小文字を区別しない
  b = b.toString().toLowerCase();

  if     (a < b){ return -1; }
  else if(a > b){ return  1; }
  return 0;
}

function trim(argStr){
 //==============================================================
 //  trim
 //==============================================================
  var rcStr = argStr;
  rcStr	= rcStr.replace(/^[ 　\r\n]+/g, '');
  rcStr	= rcStr.replace(/[ 　\r\n]+$/g, '');
  return rcStr;
}


</script>
{% endcomment %}




{% endblock %}
